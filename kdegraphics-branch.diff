Index: kpdf/xpdf/xpdf/DCTStream.cc
===================================================================
--- kpdf/xpdf/xpdf/DCTStream.cc	(.../tags/KDE/3.4.2/kdegraphics)	(revision 442272)
+++ kpdf/xpdf/xpdf/DCTStream.cc	(.../branches/KDE/3.4/kdegraphics)	(revision 442272)
@@ -15,7 +15,15 @@
 static boolean str_fill_input_buffer(j_decompress_ptr cinfo)
 {
   struct str_src_mgr * src = (struct str_src_mgr *)cinfo->src;
-  src->buffer = src->str->getChar();
+  if (src->index == 0) {
+    src->buffer = 0xFF;
+    src->index++;
+  }
+  else if (src->index == 1) {
+    src->buffer = 0xD8;
+    src->index++;
+  }
+  else src->buffer = src->str->getChar();
   src->pub.next_input_byte = &src->buffer;
   src->pub.bytes_in_buffer = 1;
   return TRUE;
@@ -50,6 +58,7 @@
   src.pub.bytes_in_buffer = 0;
   src.pub.next_input_byte = NULL;
   src.str = str;
+  src.index = 0;
   cinfo.src = (jpeg_source_mgr *)&src;
   cinfo.err = jpeg_std_error(&jerr);
   x = 0;
@@ -64,6 +73,40 @@
   int row_stride;
 
   str->reset();
+  
+  // JPEG data has to start with 0xFF 0xD8
+  // but some pdf like the one on 
+  // https://bugs.freedesktop.org/show_bug.cgi?id=3299
+  // does have some garbage before that this seeks for
+  // the start marker...
+  bool startFound = false;
+  int c = 0, c2 = 0;
+  int n = 0;
+  while (!startFound)
+  {
+    if (!c)
+    {
+      c = str->getChar();
+      if (c != 0xFF) c = 0;
+      if (c == -1)
+      {
+        error(-1, "Could not find start of jpeg data");
+        exit(1);
+      }
+    }
+    else
+    {
+      c2 = str->getChar();
+      if (c2 != 0xD8)
+      {
+        c = 0;
+        c2 = 0;
+      }
+      else startFound = true;
+    }
+    n++;
+  }
+
   jpeg_read_header(&cinfo, TRUE);
   jpeg_start_decompress(&cinfo);
 
Index: kpdf/xpdf/xpdf/DCTStream.h
===================================================================
--- kpdf/xpdf/xpdf/DCTStream.h	(.../tags/KDE/3.4.2/kdegraphics)	(revision 442272)
+++ kpdf/xpdf/xpdf/DCTStream.h	(.../branches/KDE/3.4/kdegraphics)	(revision 442272)
@@ -44,6 +44,7 @@
     struct jpeg_source_mgr pub;
     JOCTET buffer;
     Stream *str;
+    int index;
 };
 
 
Index: kpdf/xpdf/fofi/FoFiType1.cc
===================================================================
--- kpdf/xpdf/fofi/FoFiType1.cc	(.../tags/KDE/3.4.2/kdegraphics)	(revision 442272)
+++ kpdf/xpdf/fofi/FoFiType1.cc	(.../branches/KDE/3.4/kdegraphics)	(revision 442272)
@@ -186,17 +186,13 @@
 	      }
 	    }
 	  }
-	} else {
-	  p = strtok(buf, " \t\n\r");
-	  if (p)
-	  {
-	    if (!strcmp(p, "def")) break;
-	    if (!strcmp(p, "readonly")) break;
-	    // the spec does not says this but i'm mantaining old xpdf behaviour that accepts "foo def" as end of the encoding array
-	    p = strtok(buf, " \t\n\r");
-	    if (p && !strcmp(p, "def")) break;
-	  }
 	}
+	
+	// Any line that begins with "def" or contains " def"
+	// terminates the encoding array.
+	if (!strcmp (p, "def") || strstr (buf, " def"))
+	  break;
+	
 	line = line1;
       }
       //~ check for getinterval/putinterval junk
Index: kpdf/xpdf/splash/Splash.cc
===================================================================
--- kpdf/xpdf/splash/Splash.cc	(.../tags/KDE/3.4.2/kdegraphics)	(revision 442272)
+++ kpdf/xpdf/splash/Splash.cc	(.../branches/KDE/3.4/kdegraphics)	(revision 442272)
@@ -240,6 +240,11 @@
     return splashErrEmptyPath;
   }
   xPath = new SplashXPath(path, state->flatness, gFalse);
+  if (!xPath->segs)
+  {
+    delete xPath;
+    return splashErrEmptyPath;
+  }
   if (state->lineDashLength > 0) {
     xPath2 = makeDashedPath(xPath);
     delete xPath;
@@ -633,6 +638,11 @@
   }
   xPath = new SplashXPath(path, state->flatness, gTrue);
   xPath->sort();
+  if (!&xPath->segs[0])
+  {
+    delete xPath;
+    return splashErrEmptyPath;
+  }
   scanner = new SplashXPathScanner(xPath, eo);
 
   // get the min and max x and y values
Index: kview/modules/scale/kview_scale.desktop
===================================================================
--- kview/modules/scale/kview_scale.desktop	(.../tags/KDE/3.4.2/kdegraphics)	(revision 442272)
+++ kview/modules/scale/kview_scale.desktop	(.../branches/KDE/3.4/kdegraphics)	(revision 442272)
@@ -3,6 +3,7 @@
 Name[af]=Skaal
 Name[ar]=تكبير أو تصغير
 Name[bg]=Мащабиране
+Name[br]=Skeulaet
 Name[bs]=Skaliraj
 Name[ca]=Escala
 Name[cs]=Změna měřítka
Index: kolourpaint/NEWS
===================================================================
--- kolourpaint/NEWS	(.../tags/KDE/3.4.2/kdegraphics)	(revision 442272)
+++ kolourpaint/NEWS	(.../branches/KDE/3.4/kdegraphics)	(revision 442272)
@@ -32,15 +32,15 @@
 
 KolourPaint 1.4_light (Frozen 2005-02-22)
    * Antialias text when the text box has a transparent background (Bug #24)
-     [also in branches/KDE/3.3/, branches/kolourpaint/1.2_kde3/]
+     [later backported to branches/KDE/3.3/, branches/kolourpaint/1.2_kde3/]
    * Add Unzoomed Thumbnail Mode and Thumbnail Rectangle
    * Add RMB context menu for when a selection tool is active (closing KDE
      Bug #92882)
    * More intuitive "Set as Image" behaviour (esp. with selection borders).
      Thanks to Michael Lake for the feedback.
-     [also in branches/KDE/3.3/, branches/kolourpaint/1.2_kde3/]
+     [later backported to branches/KDE/3.3/, branches/kolourpaint/1.2_kde3/]
    * InputMethod support
-     [also in branches/kolourpaint/1.2_kde3/]
+     [later backported to branches/kolourpaint/1.2_kde3/]
    * Save "More Effects" dialog's last effect to config file
    * Save "Resize / Scale" dialog's last "Keep aspect ratio" setting to
      config file
Index: kolourpaint/kpmainwindow_view.cpp
===================================================================
--- kolourpaint/kpmainwindow_view.cpp	(.../tags/KDE/3.4.2/kdegraphics)	(revision 442272)
+++ kolourpaint/kpmainwindow_view.cpp	(.../branches/KDE/3.4/kdegraphics)	(revision 442272)
@@ -183,7 +183,9 @@
         items << zoomLevelToString (*it);
     }
 
-    // SYNC: work around a KDE bug - KSelectAction::setItems() enables the action
+    // Work around a KDE bug - KSelectAction::setItems() enables the action.
+    // David Faure said it won't be fixed because it's a feature used by
+    // KRecentFilesAction.
     bool e = m_actionZoom->isEnabled ();
     m_actionZoom->setItems (items);
     if (e != m_actionZoom->isEnabled ())
Index: kolourpaint/README
===================================================================
--- kolourpaint/README	(.../tags/KDE/3.4.2/kdegraphics)	(revision 442272)
+++ kolourpaint/README	(.../branches/KDE/3.4/kdegraphics)	(revision 442272)
@@ -6,10 +6,9 @@
 
 
 For licensing and warranty information, read COPYING.
-For installation instructions, read INSTALL (but not with KDE releases).
 For known problems with this release of KolourPaint, read BUGS.
 For what changes have been made, read NEWS.
-For information on what features are planned or unfinished, read TODO.
+For developer information, checkout branches/kolourpaint/control/.
 For general information, read this file (README):
 
 
Index: Makefile.cvs
===================================================================
--- Makefile.cvs	(.../tags/KDE/3.4.2/kdegraphics)	(revision 0)
+++ Makefile.cvs	(.../branches/KDE/3.4/kdegraphics)	(revision 442272)
@@ -0,0 +1,16 @@
+
+all: 
+	@echo "This Makefile is only for the CVS repository"
+	@echo "This will be deleted before making the distribution"
+	@echo ""
+	@if test ! -d admin; then \
+	   echo "Please recheckout this module!" ;\
+	   echo "for cvs: use checkout once and after that update again" ;\
+	   echo "for cvsup: checkout kde-common from cvsup and" ;\
+	   echo "   link kde-common/admin to ./admin" ;\
+	   exit 1 ;\
+	fi
+	$(MAKE) -f admin/Makefile.common cvs
+
+.SILENT:
+

Property changes on: Makefile.cvs
___________________________________________________________________
Name: svn:keywords
   + Author Date Id Revision

Index: kviewshell/centeringScrollview.h
===================================================================
--- kviewshell/centeringScrollview.h	(.../tags/KDE/3.4.2/kdegraphics)	(revision 442272)
+++ kviewshell/centeringScrollview.h	(.../branches/KDE/3.4/kdegraphics)	(revision 442272)
@@ -129,10 +129,6 @@
 
     QPtrVector<QWidget> widgetListIfOldAddChildIsUsed;
 
-    /** This is set in slotShowScrollbars() to remember the status of the
-        scrollbars when we switch from fullscreen mode back to normal mode. */
-    bool showScrollBars;
-
     /** This int remembers the style of the frame of the centering
         scrollview when fullscreen mode is switched on. It is then
         restored when it is switched off. */
Index: kviewshell/kviewpart.cpp
===================================================================
--- kviewshell/kviewpart.cpp	(.../tags/KDE/3.4.2/kdegraphics)	(revision 442272)
+++ kviewshell/kviewpart.cpp	(.../branches/KDE/3.4/kdegraphics)	(revision 442272)
@@ -453,7 +453,10 @@
     kdError(4300) << "KViewPart::slotSetFullPage() called without existing multipage" << endl;
 
   if (fullpage == false)
+  {
     slotShowSidebar();
+    multiPage->slotShowScrollbars(scrollbarHandling->isChecked());
+  }
 }
 
 
@@ -958,6 +961,8 @@
   _zoomVal.setZoomValue(sval);
   if (fval != _zoomVal.value())
     _zoomVal.setZoomValue(multiPage->setZoom(_zoomVal.value()));
+
+  mainWidget->setFocus(); 
 }
 
 
Index: kviewshell/centeringScrollview.cpp
===================================================================
--- kviewshell/centeringScrollview.cpp	(.../tags/KDE/3.4.2/kdegraphics)	(revision 442272)
+++ kviewshell/centeringScrollview.cpp	(.../branches/KDE/3.4/kdegraphics)	(revision 442272)
@@ -236,11 +236,6 @@
     setVScrollBarMode(QScrollView::AlwaysOff);
     setHScrollBarMode(QScrollView::AlwaysOff);
   }
-
-  // Remember the state of the scrollbars so that we can restore
-  // scrollbar visibility when we switch back from fullscreen mode to
-  // normal mode
-  showScrollBars = status;
 }
 
 void CenteringScrollview::setFullScreenMode(bool fullScreen)
@@ -261,7 +256,6 @@
   else
   {
     viewport()->setPaletteBackgroundColor( backgroundColor ) ;
-    slotShowScrollbars(showScrollBars);
     setFrameStyle(oldFrameStyle);
   }
 }

Property changes on: .
___________________________________________________________________
Name: svn:externals
   + admin https://svn.kde.org/home/kde/branches/KDE/3.4/kde-common/admin


